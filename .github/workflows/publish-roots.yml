name: Publish Signed Daily Roots

on:
  schedule:
    - cron: "30 0 * * *"
  workflow_dispatch:
    inputs:
      date_utc:
        description: "UTC date to export (YYYY-MM-DD). Defaults to yesterday."
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  publish-root:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install ReleaseGate
        run: |
          python -m pip install --upgrade pip
          pip install . "psycopg2-binary>=2.9.0"

      - name: Export Signed Root
        env:
          RELEASEGATE_STORAGE_BACKEND: postgres
          RELEASEGATE_POSTGRES_DSN: ${{ secrets.RELEASEGATE_POSTGRES_DSN }}
          RELEASEGATE_ROOT_SIGNING_KEY: ${{ secrets.RELEASEGATE_ROOT_SIGNING_KEY }}
          RELEASEGATE_ROOT_KEY_ID: ${{ secrets.RELEASEGATE_ROOT_KEY_ID }}
          RELEASEGATE_TENANT_ID: ${{ vars.RELEASEGATE_TENANT_ID || 'default' }}
          DATE_INPUT: ${{ github.event.inputs.date_utc }}
        run: |
          set -euo pipefail
          YESTERDAY=$(date -u -d "yesterday" +%F)
          TODAY=$(date -u +%F)

          if [ -n "${DATE_INPUT:-}" ]; then
            DATE="$DATE_INPUT"
            echo "Exporting signed root for explicit date: $DATE"
            releasegate export-root --date "$DATE" --out "roots/$DATE.json"
            echo "ROOTS_PUBLISHED=1" >> "$GITHUB_ENV"
            echo "ROOTS_PUBLISHED_DATE=$DATE" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "Trying yesterday first: $YESTERDAY"
          rc=0
          releasegate export-root --date "$YESTERDAY" --out "roots/$YESTERDAY.json" || rc=$?
          if [ "$rc" -eq 0 ]; then
            echo "ROOTS_PUBLISHED=1" >> "$GITHUB_ENV"
            echo "ROOTS_PUBLISHED_DATE=$YESTERDAY" >> "$GITHUB_ENV"
            exit 0
          fi

          if [ "$rc" -ne 2 ]; then
            echo "export-root failed for $YESTERDAY with exit code $rc"
            exit "$rc"
          fi

          echo "No root for yesterday ($YESTERDAY). Trying today: $TODAY"
          rc=0
          releasegate export-root --date "$TODAY" --out "roots/$TODAY.json" || rc=$?
          if [ "$rc" -eq 0 ]; then
            echo "ROOTS_PUBLISHED=1" >> "$GITHUB_ENV"
            echo "ROOTS_PUBLISHED_DATE=$TODAY" >> "$GITHUB_ENV"
            exit 0
          fi

          if [ "$rc" -eq 2 ]; then
            echo "No root for today ($TODAY) either. Nothing to publish."
            echo "ROOTS_PUBLISHED=0" >> "$GITHUB_ENV"
            exit 0
          fi
          exit "$rc"

      - name: Create pull request for roots
        if: env.ROOTS_PUBLISHED == '1'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: bot/publish-roots-${{ env.ROOTS_PUBLISHED_DATE }}
          delete-branch: true
          title: "chore(roots): publish signed daily root (${{ env.ROOTS_PUBLISHED_DATE }})"
          commit-message: "chore(roots): publish signed daily root (${{ env.ROOTS_PUBLISHED_DATE }})"
          body: |
            Automated publication of signed daily transparency root for `${{ env.ROOTS_PUBLISHED_DATE }}`.
          add-paths: |
            roots/${{ env.ROOTS_PUBLISHED_DATE }}.json
