name: Compliance Check

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  compliance:
    name: Compliance Check   # THIS MUST MATCH BRANCH PROTECTION EXACTLY
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # we need history for churn analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install ReleaseGate
        run: |
          pip install --upgrade pip
          pip install -e .
          # Needed for Postgres-backed storage (Neon / RDS / etc.)
          pip install "psycopg2-binary>=2.9.0"

      - name: Debug Environment
        run: |
          pip list
          which releasegate || echo "releasegate not in PATH"
          releasegate --help || echo "releasegate failed to run"

      - name: Lint Compiled Policies
        run: |
          releasegate lint-policies \
            --policy-dir "releasegate/policy/compiled" \
            --format text

      - name: Run Policy Analysis
        continue-on-error: true
        env:
          # Use the built-in GITHUB_TOKEN for API access logic in cli.py
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Persist attestations + transparency entries to Postgres so daily roots can be published.
          RELEASEGATE_STORAGE_BACKEND: postgres
          RELEASEGATE_POSTGRES_DSN: ${{ secrets.RELEASEGATE_POSTGRES_DSN }}
          # Fail-closed attestation signing key (Ed25519 private key; PEM or base64/hex raw 32 bytes).
          RELEASEGATE_SIGNING_KEY: ${{ secrets.RELEASEGATE_SIGNING_KEY }}
          # Stable key id for CI-issued attestations (used for DSSE keyid pinning).
          RELEASEGATE_ATTESTATION_KEY_ID: rg-ci-2026-02
        run: |
          echo "Running ReleaseGate analysis for PR #${{ github.event.pull_request.number }}"
          
          # Use analyze-pr (not evaluate) so we generate + persist signed attestations.
          releasegate analyze-pr \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --tenant "${{ github.repository_owner }}" \
            --emit-attestation attestation.json \
            --emit-dsse releasegate.dsse.json \
            --output compliance_report.json \
            --format json

      - name: Write Compliance Summary
        if: always()
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib

          path = pathlib.Path("compliance_report.json")
          if not path.exists():
              summary = "## Compliance Check\n\nMissing `compliance_report.json`.\n"
              pathlib.Path(os.environ["GITHUB_STEP_SUMMARY"]).write_text(summary, encoding="utf-8")
              raise SystemExit(0)

          report = json.loads(path.read_text(encoding="utf-8"))
          verdict = str(report.get("verdict") or "FAIL").upper()
          mode = str(report.get("enforcement_mode") or "monitor").lower()
          reason_codes = report.get("reason_codes") or []
          top = reason_codes[:3]

          attestation_id = report.get("attestation_id")
          policy_hash = report.get("policy_hash") or report.get("policy_resolution_hash")

          lines = []
          lines.append("## Compliance Check")
          lines.append(f"**Verdict**: `{verdict}`  ")
          lines.append(f"**Mode**: `{mode}`  ")
          if policy_hash:
              lines.append(f"**Policy Hash**: `{policy_hash}`  ")
          if attestation_id:
              lines.append(f"**Attestation ID**: `{attestation_id}`  ")
          if top:
              lines.append("")
              lines.append("**Top Reason Codes**:")
              for code in top:
                  lines.append(f"- `{code}`")
          errors = report.get("errors") or []
          if errors:
              lines.append("")
              lines.append("**Errors**:")
              for err in errors[:5]:
                  lines.append(f"- `{err}`")
              if len(errors) > 5:
                  lines.append(f"- ... ({len(errors) - 5} more)")

          lines.append("")
          lines.append("_Evidence artifacts are uploaded as a workflow artifact._")

          out = "\n".join(lines) + "\n"
          pathlib.Path(os.environ["GITHUB_STEP_SUMMARY"]).write_text(out, encoding="utf-8")
          PY

      - name: Verify DSSE artifact
        if: always()
        continue-on-error: true
        env:
          RELEASEGATE_SIGNING_KEY: ${{ secrets.RELEASEGATE_SIGNING_KEY }}
          RELEASEGATE_ATTESTATION_KEY_ID: rg-ci-2026-02
        run: |
          python - <<'PY'
          import json
          from releasegate.attestation.crypto import current_key_id, load_private_key_from_env, public_key_pem_from_private
          key_id = current_key_id()
          public_key = public_key_pem_from_private(load_private_key_from_env()).strip()
          with open("releasegate.public_keys.json", "w", encoding="utf-8") as f:
              json.dump({key_id: public_key}, f)
          PY
          releasegate verify-dsse --dsse releasegate.dsse.json --key-file releasegate.public_keys.json --require-keyid rg-ci-2026-02 --format json
          releasegate log-dsse --dsse releasegate.dsse.json --log attestations.log --format json

      - name: Generate artifact sha256 sums
        if: always()
        run: |
          set -euo pipefail
          files=()
          for f in compliance_report.json attestation.json releasegate.dsse.json attestations.log; do
            if [ -f "$f" ]; then
              files+=("$f")
            fi
          done
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No artifacts found to hash."
            exit 0
          fi
          sha256sum "${files[@]}" > releasegate.artifacts.sha256

      - name: Upload ReleaseGate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: releasegate-artifacts
          if-no-files-found: warn
          path: |
            compliance_report.json
            attestation.json
            releasegate.dsse.json
            releasegate.artifacts.sha256
            attestations.log

      - name: Gate (enforce mode only)
        if: always()
        env:
          RELEASEGATE_SIGNING_KEY: ${{ secrets.RELEASEGATE_SIGNING_KEY }}
          RELEASEGATE_ATTESTATION_KEY_ID: rg-ci-2026-02
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import subprocess
          import sys

          report_path = pathlib.Path("compliance_report.json")
          if not report_path.exists():
              print("Missing compliance_report.json; failing closed.", file=sys.stderr)
              sys.exit(1)

          report = json.loads(report_path.read_text(encoding="utf-8"))
          mode = str(report.get("enforcement_mode") or "monitor").strip().lower()
          verdict = str(report.get("verdict") or "FAIL").strip().upper()
          errors = report.get("errors") or []

          if mode != "enforce":
              print(f"Enforcement mode is {mode}; not blocking.")
              sys.exit(0)

          if errors:
              print("Report contains errors; blocking in enforce mode:", file=sys.stderr)
              for err in errors:
                  print(f" - {err}", file=sys.stderr)
              sys.exit(1)

          if verdict == "FAIL":
              print("Verdict is FAIL; blocking in enforce mode.", file=sys.stderr)
              sys.exit(1)

          dsse_path = report.get("dsse_path") or "releasegate.dsse.json"
          if not dsse_path:
              print("Missing dsse_path; blocking in enforce mode.", file=sys.stderr)
              sys.exit(1)

          dsse_file = pathlib.Path(dsse_path)
          if not dsse_file.exists():
              print(f"Missing DSSE artifact: {dsse_path}; blocking in enforce mode.", file=sys.stderr)
              sys.exit(1)

          # Build a key-id map from the configured signing key and verify DSSE.
          try:
              from releasegate.attestation.crypto import (
                  current_key_id,
                  load_private_key_from_env,
                  public_key_pem_from_private,
              )
          except Exception as e:
              print(f"Failed to import key helpers: {e}", file=sys.stderr)
              sys.exit(1)

          key_id = current_key_id()
          public_key = public_key_pem_from_private(load_private_key_from_env()).strip()
          key_map_path = pathlib.Path("releasegate.public_keys.json")
          key_map_path.write_text(json.dumps({key_id: public_key}), encoding="utf-8")

          cmd = [
              "releasegate",
              "verify-dsse",
              "--dsse",
              dsse_path,
              "--key-file",
              str(key_map_path),
              "--require-keyid",
              key_id,
              "--format",
              "json",
          ]
          result = subprocess.run(cmd, capture_output=True, text=True)
          if result.returncode != 0:
              print("DSSE verification failed; blocking in enforce mode.", file=sys.stderr)
              sys.stderr.write(result.stderr)
              sys.stderr.write(result.stdout)
              sys.exit(1)
          print("Gate passed (enforce mode).")
          sys.exit(0)
          PY
