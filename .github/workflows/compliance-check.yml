name: Compliance Check

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  compliance:
    name: Compliance Check   # THIS MUST MATCH BRANCH PROTECTION EXACTLY
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # we need history for churn analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install ReleaseGate
        run: |
          pip install --upgrade pip
          pip install -e .
          # Needed for Postgres-backed storage (Neon / RDS / etc.)
          pip install "psycopg2-binary>=2.9.0"

      - name: Debug Environment
        run: |
          pip list
          which releasegate || echo "releasegate not in PATH"
          releasegate --help || echo "releasegate failed to run"

      - name: Lint Compiled Policies
        run: |
          releasegate lint-policies \
            --policy-dir "releasegate/policy/compiled" \
            --format text

      - name: Run Policy Analysis
        env:
          # Use the built-in GITHUB_TOKEN for API access logic in cli.py
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Report-only mode for now
          COMPLIANCEBOT_ENFORCEMENT: report_only
          # Persist attestations + transparency entries to Postgres so daily roots can be published.
          RELEASEGATE_STORAGE_BACKEND: postgres
          RELEASEGATE_POSTGRES_DSN: ${{ secrets.RELEASEGATE_POSTGRES_DSN }}
          # Fail-closed attestation signing key (Ed25519 private key; PEM or base64/hex raw 32 bytes).
          RELEASEGATE_SIGNING_KEY: ${{ secrets.RELEASEGATE_SIGNING_KEY }}
        run: |
          echo "Running ReleaseGate analysis for PR #${{ github.event.pull_request.number }}"
          
          # Use analyze-pr (not evaluate) so we generate + persist signed attestations.
          releasegate analyze-pr \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --tenant "${{ github.repository_owner }}" \
            --emit-attestation attestation.json \
            --format json > compliance_report.json
