name: Compliance Check

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  compliance:
    name: Compliance Check   # THIS MUST MATCH BRANCH PROTECTION EXACTLY
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      checks: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # we need history for churn analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install ReleaseGate
        run: |
          pip install --upgrade pip
          pip install -e .
          # Needed for Postgres-backed storage (Neon / RDS / etc.)
          pip install "psycopg2-binary>=2.9.0"

      - name: Debug Environment
        run: |
          pip list
          which releasegate || echo "releasegate not in PATH"
          releasegate --help || echo "releasegate failed to run"

      - name: Lint Compiled Policies
        run: |
          releasegate lint-policies \
            --policy-dir "releasegate/policy/compiled" \
            --format text

      - name: Run Policy Analysis
        env:
          # Use the built-in GITHUB_TOKEN for API access logic in cli.py
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Report-only mode for now
          COMPLIANCEBOT_ENFORCEMENT: report_only
          # Persist attestations + transparency entries to Postgres so daily roots can be published.
          RELEASEGATE_STORAGE_BACKEND: postgres
          RELEASEGATE_POSTGRES_DSN: ${{ secrets.RELEASEGATE_POSTGRES_DSN }}
          # Fail-closed attestation signing key (Ed25519 private key; PEM or base64/hex raw 32 bytes).
          RELEASEGATE_SIGNING_KEY: ${{ secrets.RELEASEGATE_SIGNING_KEY }}
          # Stable key id for CI-issued attestations (used for DSSE keyid pinning).
          RELEASEGATE_ATTESTATION_KEY_ID: rg-ci-2026-02
        run: |
          echo "Running ReleaseGate analysis for PR #${{ github.event.pull_request.number }}"
          
          # Use analyze-pr (not evaluate) so we generate + persist signed attestations.
          releasegate analyze-pr \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --tenant "${{ github.repository_owner }}" \
            --emit-attestation attestation.json \
            --emit-dsse releasegate.dsse.json \
            --format json > compliance_report.json

      - name: Verify DSSE artifact
        env:
          RELEASEGATE_SIGNING_KEY: ${{ secrets.RELEASEGATE_SIGNING_KEY }}
          RELEASEGATE_ATTESTATION_KEY_ID: rg-ci-2026-02
        run: |
          python - <<'PY'
          import json
          from releasegate.attestation.crypto import current_key_id, load_private_key_from_env, public_key_pem_from_private
          key_id = current_key_id()
          public_key = public_key_pem_from_private(load_private_key_from_env()).strip()
          with open("releasegate.public_keys.json", "w", encoding="utf-8") as f:
              json.dump({key_id: public_key}, f)
          PY
          releasegate verify-dsse --dsse releasegate.dsse.json --key-file releasegate.public_keys.json --require-keyid rg-ci-2026-02 --format json
          releasegate log-dsse --dsse releasegate.dsse.json --log attestations.log --format json

      - name: Generate artifact sha256 sums
        run: |
          sha256sum releasegate.dsse.json attestation.json compliance_report.json attestations.log > releasegate.artifacts.sha256

      - name: Upload ReleaseGate artifacts
        uses: actions/upload-artifact@v4
        with:
          name: releasegate-artifacts
          path: |
            compliance_report.json
            attestation.json
            releasegate.dsse.json
            releasegate.artifacts.sha256
            attestations.log
