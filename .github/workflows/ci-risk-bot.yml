name: RiskBot CI

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  riskbot:
    name: RiskBot CI
    runs-on: ubuntu-latest

    steps:
      - name: Call RiskBot webhook
        env:
          WEBHOOK_URL: ${{ secrets.RISKBOT_WEBHOOK_URL }}
        run: |
          echo "Calling RiskBot at $WEBHOOK_URL"
          resp=$(curl -s -X POST "$WEBHOOK_URL" -H "Content-Type: application/json" -d "{}")
          echo "Response: $resp"
          echo "RESP=$resp" >> $GITHUB_ENV

      - name: Enforce HIGH risk
        run: |
          resp='${{ env.RESP }}'
          level=$(echo "$resp" | jq -r '.level // .risk_level // .risk?.level // empty')

          echo "Parsed risk level: $level"

          if [ "$level" = "HIGH" ]; then
            echo "❌ HIGH RISK — FAILING CI"
            exit 1
          fi

          echo "✅ Risk acceptable — PASSING CI"
          exit 0
